#!/usr/bin/env python3

import sys, json

from dtcc.dtcc_pb2 import *

def Error(message):
    print('*** Error:', str(message))
    exit(1)

def Help():
    print('Usage: dtcc-convert <infile> <outfile>')

def ReadJSON(fileName):
    'Read from JSON file'
    print('Reading JSON data from %s...' % fileName)

    # Read data from file
    with open(fileName) as f:
        jsonData = json.load(f)

    # Check for type information
    if not 'Type' in jsonData:
        Error('JSON data has missing type information')
    elif jsonData['Type'] == 'CityModel':
        print('Creating CityModel object...')
        cityModel = CityModel()
        buildings = []
        for jsonBuilding in jsonData['Buildings']:
            building = Building()
            building.uuid = jsonBuilding['UUID']
            building.height = jsonBuilding['Height']
            building.groundHeight = jsonBuilding['GroundHeight']
            vertices = []
            for jsonVertex in jsonBuilding['Footprint']:
                vertex = Vector2D()
                vertex.x = jsonVertex['x']
                vertex.y = jsonVertex['y']
                vertices.append(vertex)
            building.footPrint.vertices.extend(vertices)
            buildings.append(building)
        cityModel.buildings.extend(buildings)
        return cityModel
    elif jsonData['Type'] == 'Surface3D':
        print('Creating Surface3D object...')
        surface = Surface3D()
        jsonVertices = jsonData['Vertices']
        vertices = []
        for i in range(0, len(jsonVertices), 3):
            v = Vector3D()
            v.x = jsonVertices[i]
            v.y = jsonVertices[i + 1]
            v.z = jsonVertices[i + 2]
            vertices.append(v)
        surface.vertices.extend(vertices)
        jsonFaces = jsonData['Faces']
        faces = []
        for i in range(0, len(jsonFaces), 3):
            f = Simplex2D()
            f.v0 = jsonFaces[i]
            f.v1 = jsonFaces[i + 1]
            f.v2 = jsonFaces[i + 2]
            faces.append(f)
        surface.faces.extend(faces)
        jsonNormals = jsonData['Normals']
        normals = []
        for i in range(0, len(jsonNormals), 3):
            n = Vector3D()
            n.x = jsonNormals[i]
            n.y = jsonNormals[i + 1]
            n.z = jsonNormals[i + 2]
            normals.append(n)
        surface.normals.extend(normals)
        return surface
    elif jsonData['Type'] == 'GridField2D':
        print('Creating GridField2D object...')
        gridField = GridField2D()
        jsonGrid = jsonData['Grid']
        gridField.grid.boundingBox.p.x = jsonGrid['BoundingBox']['P']['x']
        gridField.grid.boundingBox.p.y = jsonGrid['BoundingBox']['P']['y']
        gridField.grid.boundingBox.q.x = jsonGrid['BoundingBox']['Q']['x']
        gridField.grid.boundingBox.q.y = jsonGrid['BoundingBox']['Q']['y']
        gridField.values.extend(jsonData['Values'])
        return gridField
    else:
        Error('Unknown data type %s' % jsonData['Type'])

def WriteProtobuf(object, fileName):
    'Write to Protobuf file'
    print('Writing Protobuf data to %s...' % fileName)
    with open(fileName, 'wb') as f:
        protobuf = object.SerializeToString()
        f.write(protobuf)

# Check command-line arguments
if len(sys.argv) != 3:
    Help()
    exit(1)
inFileName = sys.argv[1]
outFileName = sys.argv[2]

# Read input
inFileSuffix = inFileName.split('.')[-1]
if inFileSuffix == 'json':
    object = ReadJSON(inFileName)
else:
    Error('Unknown input data format .%s' % inFileSuffix)

# Write output
outFileSuffix = outFileName.split('.')[-1]
if outFileSuffix == 'pb':
    WriteProtobuf(object, outFileName)
else:
    Error('Unknown output data format .%s' % outFileSuffix)
